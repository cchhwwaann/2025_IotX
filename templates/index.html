<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>제스처 레시피북</title>
    <style>
        body {
            display: flex;
            margin: 0;
            font-family: Arial, sans-serif;
            height: 100vh;
            background-color: #f4f4f4;
        }
        .main-container {
            display: flex;
            width: 100%;
        }
        .recipe-list-area {
            flex: 1;
            background-color: #ffffff;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .recipe-content-area {
            flex: 1;
            background-color: #fff;
            padding: 20px;
            overflow-y: auto;
        }
        .side-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #e9ecef;
        }
        .timer-container, .tool-container {
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin: 10px;
            border-radius: 8px;
        }
        .timer-container {
            background-color: #ffffff;
            flex: 1;
        }
        .tool-container {
            background-color: #ffffff;
            flex: 1;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
        }
        .recipe-list ul {
            list-style-type: none;
            padding: 0;
        }
        .recipe-list li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-weight: bold;
        }
        .recipe-list li:hover {
            background-color: #f0f0f0;
        }
        .recipe-item {
            display: none;
        }
        .recipe-item.active {
            display: block;
        }
        /* 단계별 레시피 스타일 */
        .recipe-step {
            display: none;
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        .recipe-step.active-step {
            display: block;
        }
        .step-navigation {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .timer-display {
            font-size: 3em;
            text-align: center;
            margin: 20px 0;
            color: #555;
        }
        .timer-buttons {
            text-align: center;
        }
        .timer-buttons button, .convert-button, .step-navigation button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            transition: border 0.2s;
        }
        .timer-buttons button:hover, .convert-button:hover, .step-navigation button:hover {
            background-color: #0056b3;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: calc(100% - 10px);
        }
        .highlight {
            border: 3px solid #28a745 !important;
        }
        #finger-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
    </style>
</head>
<body>

<div class="main-container">

    <div class="recipe-list-area">
        <h2>레시피 목록</h2>
        <div class="recipe-list">
            <ul>
                <li onclick="showRecipe('chicken')">매콤한 닭볶음탕 🌶️</li>
                <li onclick="showRecipe('pasta')">쉬운 크림 파스타 🍝</li>
                <li onclick="showRecipe('curry')">간단 카레라이스 🍛</li>
            </ul>
        </div>
    </div>

    <div class="recipe-content-area">
        <div id="recipe-chicken" class="recipe-item active">
            <h3>매콤한 닭볶음탕 레시피 🌶️</h3>
            <p><strong>재료:</strong> 닭 한 마리, 감자 2개, 양파 1개, 당근 1개, 고춧가루, 간장, 설탕, 마늘</p>
            <div id="chicken-step-1" class="recipe-step active-step">
                <h4>단계 1: 닭 손질</h4>
                <p>닭을 깨끗이 씻어 한입 크기로 자른다.</p>
                <img src="/static/images/chicken_soup_1.png" alt="닭 손질 이미지" style="width:100%;">
            </div>
            <div id="chicken-step-2" class="recipe-step">
                <h4>단계 2: 재료 넣고 끓이기</h4>
                <p>냄비에 물을 넣고 손질한 닭과 감자, 당근을 넣고 끓인다.</p>
                <img src="/static/images/chicken_soup_2.png" alt="재료 넣고 끓이는 이미지" style="width:100%;">
            </div>
            <div id="chicken-step-3" class="recipe-step" data-minutes="20">
                <h4>단계 3: 양념장 추가</h4>
                <p>고춧가루, 간장, 설탕, 다진 마늘로 만든 양념장을 넣고 중불에서 20분간 끓인다.</p>
                <img src="/static/images/chicken_soup_3.png" alt="양념장 추가 이미지" style="width:100%;">
            </div>
            <div id="chicken-step-4" class="recipe-step" data-minutes="5"> <h4>단계 4: 양파 넣고 마무리</h4>
                <p>마지막으로 양파를 넣고 5분 더 끓이면 완성!</p>
                <img src="/static/images/chicken_soup_4.png" alt="완성된 닭볶음탕 이미지" style="width:100%;">
            </div>
        </div>
        
        <div id="recipe-pasta" class="recipe-item">
            <h3>쉬운 크림 파스타 레시피 🍝</h3>
            <p><strong>재료:</strong> 파스타 면 200g, 생크림 200ml, 베이컨, 양파, 마늘</p>
            <div id="pasta-step-1" class="recipe-step active-step" data-minutes="8">
                <h4>단계 1: 면 삶기</h4>
                <p>끓는 물에 소금 약간 넣고 파스타 면을 삶는다. (약 8분)</p>
                <img src="/static/images/pasta_1.png" alt="파스타 면 삶는 이미지" style="width:100%;">
            </div>
            <div id="pasta-step-2" class="recipe-step">
                <h4>단계 2: 재료 볶기</h4>
                <p>팬에 베이컨과 양파, 마늘을 볶는다.</p>
                <img src="/static/images/pasta_2.png" alt="재료 볶는 이미지" style="width:100%;">
            </div>
            <div id="pasta-step-3" class="recipe-step">
                <h4>단계 3: 생크림 넣기</h4>
                <p>생크림을 붓고 끓이다가 삶은 면을 넣고 섞는다.</p>
                <img src="/static/images/pasta_3.png" alt="생크림 넣는 이미지" style="width:100%;">
            </div>
            <div id="pasta-step-4" class="recipe-step">
                <h4>단계 4: 완성!</h4>
                <p>간을 맞춘 후 접시에 담아 맛있게 먹는다.</p>
                <img src="/static/images/pasta_4.png" alt="완성된 파스타 이미지" style="width:100%;">
            </div>
        </div>
        
        <div id="recipe-curry" class="recipe-item">
            <h3>간단 카레라이스 레시피 🍛</h3>
            <p><strong>재료:</strong> 카레용 고기, 감자, 당근, 양파, 카레 가루</p>
            <div id="curry-step-1" class="recipe-step active-step">
                <h4>단계 1: 재료 준비</h4>
                <p>고기와 채소를 한입 크기로 썬다.</p>
                <img src="/static/images/curry_1.png" alt="재료 준비 이미지" style="width:100%;">
            </div>
            <div id="curry-step-2" class="recipe-step">
                <h4>단계 2: 재료 볶기</h4>
                <p>냄비에 기름을 두르고 고기와 채소를 볶는다.</p>
                <img src="/static/images/curry_2.png" alt="재료 볶는 이미지" style="width:100%;">
            </div>
            <div id="curry-step-3" class="recipe-step">
                <h4>단계 3: 물과 가루 넣기</h4>
                <p>물을 넣고 끓이다가 채소가 익으면 카레 가루를 넣는다.</p>
                <img src="/static/images/curry_3.png" alt="카레 가루 넣는 이미지" style="width:100%;">
            </div>
            <div id="curry-step-4" class="recipe-step">
                <h4>단계 4: 완성!</h4>
                <p>잘 저어가며 끓이다가 걸쭉해지면 불을 끈다.</p>
                <img src="/static/images/curry_4.png" alt="완성된 카레 이미지" style="width:100%;">
            </div>
        </div>

        <div class="step-navigation">
            <button id="prev-step-btn" onclick="prevStep()">이전</button>
            <button id="next-step-btn" onclick="nextStep()">다음 단계</button>
        </div>
    </div>

    <div class="side-area">

        <div class="timer-container">
            <h2>요리 타이머</h2>
            <div class="timer-display" id="timer-display">00:00</div>
            <div class="timer-buttons">
                <button onclick="startTimer()">시작</button>
                <button onclick="stopTimer()">정지</button>
                <button onclick="resetTimer()">초기화</button>
            </div>
            <input type="number" id="minutes" placeholder="분" style="width: calc(50% - 10px); float: left;">
            <input type="number" id="seconds" placeholder="초" style="width: calc(50% - 10px); float: right;">
        </div>

        <div class="tool-container">
            <h2>단위 변환기</h2>
            <p>온도 변환</p>
            <input type="number" id="celsius-input" placeholder="섭씨 (°C)">
            <p>
                <button class="convert-button" onclick="convertTemperature('celsius')">화씨 변환</button>
                <button class="convert-button" onclick="convertTemperature('fahrenheit')">섭씨 변환</button>
            </p>
            <p id="temp-result" style="font-weight: bold;"></p>
        </div>
    </div>

</div>

<canvas id="finger-canvas"></canvas>

<script>
    // ----------------------------------------------------
    // *** 캔버스에 빨간 점 표시 기능 ***
    // ----------------------------------------------------
    const canvas = document.getElementById('finger-canvas');
    const ctx = canvas.getContext('2d');

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function drawFingerPoint(x, y) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        ctx.arc(x, y, 10, 0, 2 * Math.PI);
        ctx.fillStyle = 'red';
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#fff';
        ctx.stroke();
    }

    // ----------------------------------------------------
    // *** 제스처 인식 및 버튼 매핑 관련 코드 ***
    // ----------------------------------------------------
    let allButtons = [];
    let currentHighlightedButton = null;
    let pinchDetected = false;

    // 단계별 레시피 제어를 위한 변수
    let currentStepIndex = 0;
    let totalSteps = 0;

    // showRecipe 함수
    function showRecipe(recipeId) {
        const allRecipeItems = document.querySelectorAll('.recipe-item');
        allRecipeItems.forEach(item => {
            item.classList.remove('active');
        });
        document.getElementById('recipe-' + recipeId).classList.add('active');
        
        // 새로운 단계 전환 로직
        currentStepIndex = 0;
        const currentRecipe = document.getElementById('recipe-' + recipeId);
        const steps = currentRecipe.querySelectorAll('.recipe-step');
        totalSteps = steps.length;
        
        steps.forEach(step => step.classList.remove('active-step'));
        steps[0].classList.add('active-step');
        
        // 첫 단계의 타이머 설정
        setTimerFromStep(steps[0]);
        
        // 버튼 상태 업데이트
        updateNavigationButtons();
    }
    
    // 다음 단계로 이동하는 함수
    function nextStep() {
        const currentRecipe = document.querySelector('.recipe-item.active');
        const steps = currentRecipe.querySelectorAll('.recipe-step');
    
        if (currentStepIndex < totalSteps - 1) {
            steps[currentStepIndex].classList.remove('active-step');
            currentStepIndex++;
            steps[currentStepIndex].classList.add('active-step');
            
            // 변경된 부분: 다음 단계의 시간을 자동으로 설정
            setTimerFromStep(steps[currentStepIndex]);
        }
        updateNavigationButtons();
    }
    
    // 이전 단계로 이동하는 함수
    function prevStep() {
        const currentRecipe = document.querySelector('.recipe-item.active');
        const steps = currentRecipe.querySelectorAll('.recipe-step');
    
        if (currentStepIndex > 0) {
            steps[currentStepIndex].classList.remove('active-step');
            currentStepIndex--;
            steps[currentStepIndex].classList.add('active-step');
            
            // 변경된 부분: 이전 단계의 시간을 자동으로 설정
            setTimerFromStep(steps[currentStepIndex]);
        }
        updateNavigationButtons();
    }
    
    // 새로 추가된 함수: 단계에 따라 타이머를 설정
    function setTimerFromStep(stepElement) {
        const minutesInput = document.getElementById('minutes');
        const secondsInput = document.getElementById('seconds');
        
        // data-* 속성에서 값 읽기
        const minutes = stepElement.getAttribute('data-minutes') || '';
        const seconds = stepElement.getAttribute('data-seconds') || '';
        
        minutesInput.value = minutes;
        secondsInput.value = seconds;

        // 타이머 디스플레이 업데이트
        let minDisplay = String(minutes).padStart(2, '0');
        let secDisplay = String(seconds).padStart(2, '0');
        document.getElementById('timer-display').innerText = `${minDisplay}:${secDisplay}`;
        
        clearInterval(timerInterval); // 타이머가 실행 중이면 중지
        totalSeconds = parseInt(minutes) * 60 + parseInt(seconds); // 총 시간 재설정
    }
    
    // 네비게이션 버튼의 상태를 업데이트하는 함수
    function updateNavigationButtons() {
        const nextBtn = document.getElementById('next-step-btn');
        const prevBtn = document.getElementById('prev-step-btn');
    
        prevBtn.style.display = (currentStepIndex > 0) ? 'inline-block' : 'none';
        
        if (currentStepIndex === totalSteps - 1) {
            nextBtn.innerText = '레시피 완료!';
        } else {
            nextBtn.innerText = '다음 단계';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        showRecipe('chicken');
        allButtons = Array.from(document.querySelectorAll('.timer-buttons button, .convert-button, .recipe-list li, #next-step-btn, #prev-step-btn'));
        
        setInterval(fetchFingerPosition, 100);
    });

    function fetchFingerPosition() {
        fetch('/get_finger_pos')
            .then(response => response.json())
            .then(data => {
                const fingerX = data.x * window.innerWidth;
                const fingerY = data.y * window.innerHeight;
                const isPinch = data.isPinch;

                if (!isNaN(fingerX) && !isNaN(fingerY)) {
                    drawFingerPoint(fingerX, fingerY);
                    const closestButton = findClosestButton(fingerX, fingerY);
                    highlightButton(closestButton);
                    handlePinchClick(closestButton, isPinch);
                }
            })
            .catch(error => console.error('Error fetching data:', error));
    }

    function findClosestButton(x, y) {
        let closestBtn = null;
        let minDistance = Infinity;

        allButtons.forEach(btn => {
            const rect = btn.getBoundingClientRect();
            const btnX = rect.left + rect.width / 2;
            const btnY = rect.top + rect.height / 2;
            
            const distance = Math.sqrt(Math.pow(btnX - x, 2) + Math.pow(btnY - y, 2));

            if (distance < minDistance) {
                minDistance = distance;
                closestBtn = btn;
            }
        });
        return closestBtn;
    }

    function highlightButton(button) {
        if (currentHighlightedButton && currentHighlightedButton !== button) {
            currentHighlightedButton.classList.remove('highlight');
        }
        if (button) {
            button.classList.add('highlight');
            currentHighlightedButton = button;
        }
    }

    function handlePinchClick(button, isPinch) {
        if (isPinch && !pinchDetected) {
            pinchDetected = true;
            if (button) {
                button.click();
                allButtons.forEach(btn => {
                    btn.classList.remove('highlight');
                });
                
                button.style.border = '3px solid #ffc107';
                
                setTimeout(() => {
                    highlightButton(currentHighlightedButton);
                    button.style.border = ''; // 노란색 테두리 제거
                }, 200);
            }
        } else if (!isPinch) {
            pinchDetected = false;
        }
    }
    
    // ----------------------------------------------------
    // *** 타이머 및 단위 변환기 관련 코드 ***
    // ----------------------------------------------------
    let timerInterval;
    let totalSeconds = 0;

    function startTimer() {
        const minutes = parseInt(document.getElementById('minutes').value) || 0;
        const seconds = parseInt(document.getElementById('seconds').value) || 0;
        totalSeconds = minutes * 60 + seconds;
        if (totalSeconds <= 0) {
            alert("유효한 시간을 입력하세요.");
            return;
        }
        clearInterval(timerInterval);
        timerInterval = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
        if (totalSeconds <= 0) {
            clearInterval(timerInterval);
            document.getElementById('timer-display').innerText = "시간 초과!";
            alert("타이머가 종료되었습니다!");
            return;
        }
        totalSeconds--;
        let min = Math.floor(totalSeconds / 60);
        let sec = totalSeconds % 60;
        document.getElementById('timer-display').innerText = 
            `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    }

    function stopTimer() {
        clearInterval(timerInterval);
    }

    function resetTimer() {
        clearInterval(timerInterval);
        totalSeconds = 0;
        document.getElementById('timer-display').innerText = "00:00";
        document.getElementById('minutes').value = '';
        document.getElementById('seconds').value = '';
    }

    function convertTemperature(type) {
        const celsiusInput = document.getElementById('celsius-input');
        const tempResult = document.getElementById('temp-result');
        const value = parseFloat(celsiusInput.value);
        if (isNaN(value)) {
            tempResult.innerText = "유효한 숫자를 입력하세요.";
            return;
        }
        let result;
        if (type === 'celsius') {
            result = (value * 1.8 + 32).toFixed(2);
            tempResult.innerText = `화씨: ${result} °F`;
        } else if (type === 'fahrenheit') {
            result = ((value - 32) / 1.8).toFixed(2);
            tempResult.innerText = `섭씨: ${result} °C`;
        }
    }
</script>

</body>
</html>